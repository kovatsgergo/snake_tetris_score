<!doctype html>
<html>

<head>
  <title>Score Launcher</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="/style.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
</head>

<body>
  <div id="control">
    <fieldset>
      <legend>
        Startup
        <button id="start" onclick="startScore()" disabled="true">
          START!
        </button>
      </legend>
      <label for="rooms">Choose a room:</label>
      <select id="rooms" style="width: 100px;"></select>
      <label for="behavior" style="margin-left: 12px;">Client:</label>
      <select id="behavior" style="width: 120px;">
        <option value="uzp" selected>UZP</option>
        <option value="old">old</option>
      </select>
    </fieldset>
  </div>
  <fieldset>
    <legend>Debug <button onclick="toggleDebug()">toggle</button></legend>
    <div id="control3" style="display: none;">
      <p id="net">net</p>
      <p id="debug">debug</p>
    </div>
  </fieldset>
</body>

<script>
  var HOST = location.origin.replace(/^http/, 'ws');
  var ws = new WebSocket(HOST);
  var availableRooms = [];

  function startScore() {
    var room = Number(document.getElementById('rooms').value);
    if (!Number.isFinite(room) || room <= 0) {
      return;
    }

    var behavior = document.getElementById('behavior').value === 'old' ? 'old' : 'uzp';
    var targetPath = behavior === 'old' ? '/indexold.html' : '/index3.html';
    var targetUrl = targetPath + '?room=' + encodeURIComponent(room) + '&autostart=1';

    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.close();
    }
    window.location.href = targetUrl;
  }

  $('#rooms').bind('click change', function () {
    checkStart();
  });

  function checkStart() {
    var room = Number($('#rooms').val());
    $('#start').prop('disabled', !(room > 0));
  }

  function toggleDebug() {
    $('#control3').slideToggle(300, function () { });
  }

  function handleIDS(message) {
    availableRooms = message.split(',').map(function (v) { return String(v); });
    var select = document.getElementById('rooms');
    var previous = select.value;
    while (select.options.length) {
      select.remove(0);
    }
    availableRooms.forEach(function (roomId) {
      select.options.add(new Option(roomId, roomId));
    });

    if (previous && availableRooms.includes(previous)) {
      select.value = previous;
    }

    if (!select.value && select.options.length > 0) {
      select.selectedIndex = 0;
    }
    checkStart();
  }

  ws.onopen = function () {
    ws.send('IAMSCORE');
    document.getElementById('net').innerHTML = 'websocket connection opened';
  };

  ws.onclose = function (event) {
    document.getElementById('net').innerHTML = 'websocket connection closed ' + (event.data || '');
  };

  ws.onerror = function (event) {
    document.getElementById('net').innerHTML = 'websocket connection error ' + (event.data || '');
  };

  ws.onmessage = function (event) {
    if (event.data.startsWith('IDS ')) {
      handleIDS(event.data.replace('IDS ', ''));
    } else {
      document.getElementById('debug').innerHTML = 'unhandled ' + event.data;
    }
  };
</script>

</html>

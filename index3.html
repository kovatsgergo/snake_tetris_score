<!doctype html>
<!--https://www.tutorialsteacher.com/nodejs/serving-static-files-in-nodejs-->
<html>

<head>
  <title>Score for Snake-Tetris (Variant 3, OSMD)</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="/style.css">
  <!--link rel="preload" href="/font/Petaluma.eot" as="font">
  <link rel="preload" href="/font/Petaluma.ttf" as="font">
  <link rel="preload" href="/font/Petaluma.woff" as="font"-->
  <script type="text/javascript" src="/node_modules/vexflow/releases/vexflow-debug.js"></script>
  <script type="text/javascript" src="/node_modules/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js"></script>
  <script>
    if (!window.opensheetmusicdisplay) {
      document.write('<script src=\"https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.9.2/build/opensheetmusicdisplay.min.js\"><\\/script>');
    }
  </script>
  <script type="text/javascript" src="/stemsPatch.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>

<body>
  <div id="control">
    <fieldset>
      <legend>
        Startup
        <button id="start" onclick="startScore()" disabled="true">
          START!
        </button>
      </legend>
      <label for="rooms">Choose a room:</label>
      <select id="rooms" style="width: 100px;">
        <!--option value=-1>-1</option>
        <option value=1>1</option>
        <option value=2>2</option-->
      </select>
    </fieldset>
  </div>
  <div id="control2" style="position: relative; display: none;" >
    <fieldset>
      <legend id="playLegend">
        PLAY!
        <button id="back" onclick="goBack()">
          Quit from this room
        </button>
      </legend>
      <div id="topControlRow" class="top-control-row">
        <div id="mainControlStack" class="main-control-stack">
          <div id="staffChooserWrap" class="top-control-block">
            <label for="staffChooser"><strong>Choose staff:</strong></label>
            <select id="staffChooser" onchange="onStaffChooserChange()"></select>
          </div>
          <div id="metronomeWrap" class="top-control-block metronome-wrap">
            <strong>Tempo:</strong>
            <span id="bpmValue">40 BPM</span>
            <strong>Beat:</strong>
            <span id="metBeatIndex" class="met-beat-index">1</span>
            <strong>Metronome:</strong>
            <span id="metLedQuarter" class="met-led met-led-red" title="Quarter pulse"></span>
            <span id="metLedEighth" class="met-led met-led-blue" title="Offbeat eighth pulse"></span>
          </div>
        </div>
      </div>
      <div id="tacetBanner" style="display: none; font-size: 48px; font-weight: bold; letter-spacing: 0.15em; color: #666; padding: 4px 0; text-align: left;">TACET</div>
      <div id="score"></div>
      <div>
        <canvas id="dynCanvas" width="900" height="32"></canvas>
      </div>
    </fieldset>
  </div>
  <fieldset>
    <legend>Debug <button onclick="toggleDebug()">toggle</button></legend>
    <div id="control3" style="display: none;">
      <div style="margin: 8px 0;">
        <label for="debugFromQuarter">fromQuarter:</label>
        <input
          id="debugFromQuarter"
          type="number"
          min="0"
          step="1"
          style="width: 90px;"
          oninput="onDebugSliceControlChange()"
        />
        <label for="debugTransposeSemitones" style="margin-left: 12px;">transpose (st):</label>
        <input
          id="debugTransposeSemitones"
          type="number"
          min="-6"
          max="6"
          step="1"
          value="0"
          style="width: 70px;"
          oninput="onTransposeSemitoneChange()"
          onchange="onTransposeSemitoneChange()"
        />
        <label for="debugNumQuarters" style="margin-left: 12px;">numQuarters:</label>
        <input
          id="debugNumQuarters"
          type="number"
          min="1"
          step="1"
          style="width: 90px;"
          oninput="onDebugSliceControlChange()"
        />
        <button
          id="copyCaseReportBtn"
          type="button"
          style="margin-left: 12px; font-size: 11px; padding: 2px 6px; line-height: 1.1;"
          onclick="copyCaseReport()"
        >
          Copy Case Report
        </button>
      </div>
      <div id="renderOptionsWrap" style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
        <strong>Spacing:</strong>
        <select id="spacingMode" onchange="onSpacingModeChange()">
          <option value="engraved" selected>Engraved</option>
          <option value="linear">Linear rhythmic</option>
        </select>
        <strong>Score font:</strong>
        <select id="scoreFont" onchange="onScoreFontChange()">
          <option value="Bravura" selected>Bravura</option>
          <option value="Gonville">Gonville</option>
          <option value="Petaluma">Petaluma</option>
        </select>
        <strong>Stem rules:</strong>
        <label for="stemRulesEnabled" style="display: inline-flex; align-items: center; gap: 4px;">
          <input
            id="stemRulesEnabled"
            type="checkbox"
            checked
            onchange="onStemRulesEnabledChange()"
          />
          on
        </label>
      </div>
      <p id="net">net</p>
      <p id="snake">snake</p>
      <p id="eaten">eaten</p>
      <p id="dynamics">dynamics</p>
      <p id="notemap">neotemap</p>
      <p id="tempo">tempo</p>
      <p id="rhythm">rhythm</p>
      <p id="renderInfo">render info</p>
      <p id="debug">debug</p>
    </div>
  </fieldset>
  <!-- ONLY HERE TO LOAD THE FONT IN TIME (doesn't load if display: none)-->
  <div style="height: 0; font-family: Petaluma; visibility: collapse;">k</div>
</body>

<script src="/config.js"></script>
<script src="/score3-core.js"></script>
<script src="/score3-parse.js"></script>
<script src="/score3-layout.js"></script>
<script>
  var HOST = location.origin.replace(/^http/, 'ws');

  var ws = new WebSocket(HOST);
  var el;
  var room = -1;
  var launchParams = new URLSearchParams(window.location.search);
  var launchRoom = Number(launchParams.get('room'));
  var launchAutoStart = launchParams.get('autostart') === '1';
  var launchAutoStarted = false;
  var playText = 'PLAY!';
  var youReIn = ' â€“ You\'re in room nr. ';
  var scoreElement = document.getElementById('score');
  var clockSyncTimerID = 0;

  function init(){
    $('#control2').slideUp();
  }
  
  function startScore() {
    room = document.getElementById('rooms').value;
    //console.log("selection " + room);
    ws.send('JOIN ' + room);
    $('#control').slideUp();
    $('#control2').slideDown();
    //el = document.getElementById('back');
    $('#playLegend').html(playText + youReIn + room
      + document.getElementById('back').outerHTML);
    //$('legend#playLegend').append($('#back'));
    scoreElement.style.opacity = "1";
    //clearScore();
  }

  $('#rooms').bind('click change', function () {
    checkStart();
  });

  function checkStart() {
    //console.log('room val ' + document.getElementById('').val());
    room = Number($('#rooms').val());
    (room > 0) ?
      $('#start').prop('disabled', false) : $('#start').prop('disabled', true);
  }

  function goBack() {
    ws.send('BACK');
    //console.log("go BACK");
    $('#control2').slideUp()
    $('#control').slideDown();
    clearScore();
  }

  function toggleDebug() {
    $('#control3').slideToggle(300, function () { });
  }

  function scoreDisconnect() {
    $('#playLegend').html(playText + youReIn + room + ' (disconnected)'
      + document.getElementById('back').outerHTML);
    //$('#playLegend').append($('#back'));
    scoreElement.style.opacity = "0.3";
  }

  //https://www.jstips.co/en/javascript/working-with-websocket-timeout/
  var timerID = 0;

  function keepAlive() {
    var timeout = 20000;
    if (ws.readyState == webSocket.OPEN) {
      ws.send('');
    }
    timerID = setTimeout(keepAlive, timeout);
  }

  function cancelKeepAlive() {
    if (timerID) {
      clearTimeout(timerID);
    }
  }

  function handleIDS(message) {
    var IDS = message.split(',');
    el = document.getElementById('rooms');
    while (el.options.length) {
      el.remove(0);
    }
    IDS.forEach((element, index) => {
      var opt = new Option(element, element);
      el.options.add(opt);
    });
    if (room != -1 && !IDS.includes(String(room))) {
      scoreDisconnect();
      //console.log('room disappeared');
    }
    //console.log('el value ' + el.value);
    if (!el.value) {
      console.log("NOTVALUE")
      el.selectedIndex = 0;
    }
    //console.log('el selected ' + el.selectedIndex);
    checkStart();
    if (!launchAutoStarted && launchAutoStart && Number.isFinite(launchRoom) && launchRoom > 0) {
      var launchRoomText = String(launchRoom);
      if (IDS.includes(launchRoomText)) {
        el.value = launchRoomText;
        checkStart();
        launchAutoStarted = true;
        startScore();
      }
    }
    //console.log('room ' + room);
    //console.log('after IDS ' + el.value);
  }

  ws.onopen = function (event) {
    ws.send('IAMSCORE');
    requestClockSync();
    if (!clockSyncTimerID) {
      clockSyncTimerID = setInterval(requestClockSync, 4000);
    }
    el = document.getElementById('net').innerHTML 
    = 'websocket connection opened ';
  };

  ws.onclose = function (event) {
    if (clockSyncTimerID) {
      clearInterval(clockSyncTimerID);
      clockSyncTimerID = 0;
    }
    document.getElementById('net').innerHTML =
     'websocket connection closed ' + event.data;
  }

  ws.onerror = function (event) {
    el = document.getElementById('net');
    el.innerHTML = 'websocket connection error ' + event.data;
  }

  ws.onmessage = function (event) {
    //console.log('GOT MESSAGE: ' + event.data);
    if (event.data.startsWith('SRVTIME ')) {
      if (typeof setServerMessageTime === 'function') {
        setServerMessageTime(Number(event.data.replace('SRVTIME ', '')));
      }
    } else if (event.data.startsWith('TRANSPORT ')) {
      var transportParts = event.data.trim().split(/\s+/);
      if (transportParts.length >= 3 && typeof setTransportState === 'function') {
        setTransportState(transportParts[1], transportParts[2], transportParts[3], transportParts[4]);
      }
    } else if (event.data.startsWith('TEMPO_TABLE ')) {
      var tempoTableParts = event.data.trim().split(/\s+/).slice(1);
      var tempoLevels = tempoTableParts.map(function (v) { return Number(v); })
        .filter(function (v) { return Number.isFinite(v); });
      if (tempoLevels.length > 0 && typeof setTempoLevels === 'function') {
        setTempoLevels(tempoLevels);
      }
    } else if (event.data.startsWith('SYNC ')) {
      var syncParts = event.data.split(' ');
      if (syncParts.length >= 3 && typeof applyClockSyncSample === 'function') {
        applyClockSyncSample(Number(syncParts[1]), Number(syncParts[2]), Date.now());
      }
    } else if (event.data.startsWith('IDS ')) {
      handleIDS(event.data.replace('IDS ', ''));
    } else if (event.data.startsWith('TACET')) {
      setTacetSet(event.data.replace('TACET', '').trim());
    } else if (event.data.startsWith('eaten')) {
      document.getElementById('eaten').innerHTML = event.data;
      setEaten(event.data.replace('eaten ', ''));
    } else if (event.data.startsWith('snake')) {
      document.getElementById('snake').innerHTML =
        event.data;
      setSnakeCoordinates(event.data.replace('snake ', ''));
      console.log(event.data);
    } else if (event.data.startsWith('tempo')) {
      document.getElementById('tempo').innerHTML =
        event.data;
      var tempoParts = event.data.trim().split(/\s+/);
      setTempo(tempoParts.length > 1 ? tempoParts[1] : NaN);
    } else if (event.data.startsWith('dynam')) {
      document.getElementById('dynamics').innerHTML =
        event.data;
      setDynamics(event.data.replace('dynam ', ''));
    } else if (event.data.startsWith('notem')) {
      document.getElementById('notemap').innerHTML =
        event.data;
      setNotemap(event.data.replace('notem ', ''));
    } else if (event.data.startsWith('rhyth')) {
      document.getElementById('rhythm').innerHTML =
        event.data;
      setRhythm(event.data.replace('rhyth ', ''));
    } else {
      //WE DON'T KNOW WHAT IT IS BUT LET'S PUT IT ON THE DEBUG <p>
      document.getElementById('debug').innerHTML = "unhandled " + event.data;
    }
  };
  //const testMessage = 'eatenSnake 11 21 -1 0.41666666 1.0 0.8 snake 11 21 10 21 9 21 8 21 7 21 6 21 5 21 4 21 3 21 2 21 1 21';
  //handleMessage(testMessage);
  //el = document.getElementById('debug');
  //el.innerHTML = 'from snake: ||' + testMessage + "||";
  // const staff = document.getElementById('boo');
  // while (staff.hasChildNodes()) {
  //    staff.removeChild(staff.lastChild);
  // }

  function wsSend(message) {
    //console.log('SENT MESSAGE ' + message);
    ws.send(message);
  }

  function requestClockSync() {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send('SYNC ' + Date.now());
    }
  }

  function onDebugSliceControlChange() {
    if (typeof setDebugSliceControls !== 'function') {
      return;
    }
    setDebugSliceControls(
      document.getElementById('debugFromQuarter').value,
      document.getElementById('debugNumQuarters').value
    );
  }

  function onTransposeSemitoneChange() {
    if (typeof setTransposeSemitones !== 'function') {
      return;
    }
    setTransposeSemitones(document.getElementById('debugTransposeSemitones').value);
  }

  function onStaffChooserChange() {
    if (typeof setSelectedStaff !== 'function') {
      return;
    }
    setSelectedStaff(document.getElementById('staffChooser').value);
  }

  function onSpacingModeChange() {
    if (typeof setSpacingMode !== 'function') {
      return;
    }
    setSpacingMode(document.getElementById('spacingMode').value);
  }

  function onScoreFontChange() {
    if (typeof setScoreFont !== 'function') {
      return;
    }
    setScoreFont(document.getElementById('scoreFont').value);
  }

  function onStemRulesEnabledChange() {
    if (typeof setStemRulesEnabled !== 'function') {
      return;
    }
    var checkbox = document.getElementById('stemRulesEnabled');
    setStemRulesEnabled(checkbox ? checkbox.checked : true);
  }

  async function copyCaseReport() {
    if (typeof copyCaseReportToClipboard !== 'function') {
      return;
    }
    await copyCaseReportToClipboard();
  }

  function removeOptions(selectElement) {
    var i, L = selectElement.options.length - 1;
    for (i = L; i >= 0; i--) {
      selectElement.remove(i);
    }
  }
</script>

</html>

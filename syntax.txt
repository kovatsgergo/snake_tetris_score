Snake-Tetris Score Protocol Syntax
==================================

Last verified from (current code)
---------------------------------
- `server2.js`
- `index.html` + `score-generator.js` (original score client)
- `index2.html` + `score-generator2.js` (current variant)
- `snake.full.decoded.js` (decoded snake build)
- `SNAKE.MESSAGES.txt` (legacy notes)

Transport
---------
- WebSocket text frames only.
- Messages are plain strings: `<type> <payload...>`.
- No JSON schema on the wire.
- Routing in `server2.js` is mostly `startsWith(...)` based.

Endpoints
---------
- Score clients connect to `location.origin.replace(/^http/, 'ws')`.
- Snake host websocket target is compiled in snake build.

Room Model (`server2.js`)
-------------------------
- One snake host socket per room.
- Multiple score clients can join that room.
- Room IDs are in-memory incremental integers.
- Restarting server resets room IDs/state.

Message Types by Direction
--------------------------
1) Snake -> Server
- `IAMSNAKE <roomIdHint>`
- Any other payload is treated as snake data and forwarded to joined score clients.

2) Server -> Snake
- `ACCEPTED <roomId>`
- `CLIENTS <count>`
- Score-originated passthrough messages (for example `snake` pull requests).

3) Score -> Server
- `IAMSCORE`
- `JOIN <roomId>`
- `BACK`
- `snake` (explicit pull request to snake host)
- `SYNC <clientSentAtMs>` (clock sync request, Variant 2 client)
- Any other payload is forwarded to snake host in that room.

4) Server -> Score
- `IDS <id1,id2,...>`
- `SYNC <clientSentAtMs> <serverNowMs>` (response to score `SYNC`)
- `SRVTIME <serverNowMs>` (sent before forwarded snake packet for sync-enabled clients)
- Forwarded snake packets: `notem`, `eaten`, `dynam`, `rhyth`, `snake`, `tempo`.

Snake Data Packet Syntax
------------------------
1) `notem`
- Format: `notem <f0> <f1> ... <f11>`
- 12 numeric note-probability values.

2) `eaten`
- Canonical format: `eaten <x> <y> <amount> <hueBin> <satBin> <value>`
- Field meanings:
  - `x`, `y`: food grid coordinate
  - `amount`: food effect code
  - `hueBin`: hue/30 bucket
  - `satBin`: saturation*3 bucket
  - `value`: HSV value/brightness
- Variant 2 parser is tolerant: it extracts numeric tokens and uses the first 6 as canonical eaten fields.

3) `dynam`
- Format: `dynam <d0> <d1> ...`
- Numeric values (ints or floats in current usage), one per snake segment.

4) `rhyth`
- Format: `rhyth <r0> <r1> ...`
- Turn/run rhythm coding from snake movement.

5) `snake`
- Format: `snake <x0> <y0> <x1> <y1> ...`
- Flat coordinate list.
- Serialized tail -> head (head is final pair).

6) `tempo`
- Format: `tempo <t>`
- Numeric control value from snake speed.

Score-Side Interpretation
-------------------------
Original client (`index.html` + `score-generator.js`)
- `tempo` mapping: `tempo = Number(t) * 0.25 + 0.25` (quarter-per-second style).
- `eaten` is stored as-is.
- `snake` updates render immediately.
- Playbar requests `snake` again at phrase end.

Variant 2 client (`index2.html` + `score-generator2.js`)
- Clock sync:
  - Sends `SYNC <Date.now()>` on open and every 4s.
  - Uses server `SYNC ...` and `SRVTIME ...` for shared timing.
- `tempo` mapping to BPM-like value:
  - `tempo = Number(t) * 15 + 50`
  - quarter rate used by playhead/metronome is `tempo / 60`.
- `eaten` drives transpose:
  - `transposeSemitones = clamp(hueBin - 6, -6..+6)`
- `snake` timing/order handling:
  - `eaten` may arrive before fresh `snake`.
  - On `eaten`, client requests `snake` immediately and waits for fresher snake snapshot.
  - Passage content latch updates on eaten-sync point.
- Slice mapping:
  - `fromQuarter = headY * 16 + headX` (head is last snake pair)
  - `numQuarters = snake.length / 2`
- Dynamics rendering pipeline (Variant 2):
  - Receive float/int `dynam` values.
  - Remap for canvas text/color: clamp source `0..9`, map to `1..9`, round integer.
  - Crescendo and decrescendo spans use intra-quarter color gradients to next quarter color.

Pull/Push Behavior
------------------
- Snake can push state packets (`notem/eaten/dynam/rhyth/snake/tempo`) to room clients.
- Score can pull by sending `snake`.
- Variant 2 additionally auto-sends `snake`:
  - on `eaten` (request fresh state)
  - at end of phrase/play cycle (loop update request)

Legacy Notes
------------
- Historical docs/examples mention `eatenSnake`.
- Current websocket handlers use `eaten`.
- Variant 2 eaten parser remains tolerant to mixed/legacy token streams by numeric extraction.

Protocol Caveats
----------------
- Server performs minimal validation and mostly forwards raw payload strings.
- `snake` is overloaded:
  - score->snake command (`"snake"` request)
  - snake->score data packet (`"snake <coords...>"`)
- Direction/context determines meaning.
